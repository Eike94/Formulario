<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário de Pedido de Camiseta</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <h1>Formulário de Pedido de Camiseta</h1>
    <form id="pedidoForm">
        <label for="nome">Nome do Cliente:</label>
        <input type="text" id="nome" name="nome" required><br><br>

        <label for="cor">Cor do Tecido:</label>
        <input type="text" id="cor" name="cor" required><br><br>

        <label>Áreas a serem estampadas:</label><br>
        <input type="checkbox" id="peito" name="estampa" value="Somente Peito">
        <label for="peito">Somente Peito</label><br>
        <input type="checkbox" id="costas" name="estampa" value="Somente Costas">
        <label for="costas">Somente Costas</label><br>
        <input type="checkbox" id="mangaDir" name="estampa" value="Manga Direita">
        <label for="mangaDir">Manga Direita</label><br>
        <input type="checkbox" id="mangaEsq" name="estampa" value="Manga Esquerda">
        <label for="mangaEsq">Manga Esquerda</label><br><br>

        <label for="tipo">Tipo de Camiseta:</label>
        <input type="text" id="tipo" name="tipo" required><br><br>

        <label for="obs1">Observação:</label>
        <textarea id="obs1" name="obs1"></textarea><br><br>

        <label for="anexo">Anexar Arquivo:</label>
        <input type="file" id="anexo" name="anexo" accept="image/*,application/pdf"><br><br>

        <button type="button" id="authenticateButton">Autenticar</button>
        <button type="button" onclick="enviarPedido()">Enviar Pedido</button>
    </form>

    <script>
        const CLIENT_ID = '403119419604-jn15e6uanvpdut4bfeffpo44u2konkpj.apps.googleusercontent.com'; // Substitua pelo seu Client ID
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const FOLDER_ID = '1f1sP_9Up6EU-aSJIMMrFanxbBd4nlL21'; // ID da pasta "Artes a Fazer"
        const WHATSAPP_NUMBER = '35988999288'; // Substitua pelo seu número de WhatsApp

        let accessToken = '';
        let numeroPedido = 1; // Inicializa o número do pedido

        // Inicializar o cliente GIS
        window.onload = function () {
            const tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (response) => {
                    if (response.error) {
                        console.error('Erro ao obter o token:', response.error);
                    } else {
                        accessToken = response.access_token;
                        alert('Autenticação bem-sucedida!');
                    }
                },
            });

            document.getElementById('authenticateButton').addEventListener('click', () => {
                tokenClient.requestAccessToken();
            });
        };

        async function enviarPedido() {
            if (!accessToken) {
                alert('Por favor, autentique-se primeiro.');
                return;
            }

            const nome = document.getElementById('nome').value;
            const cor = document.getElementById('cor').value;
            const tipo = document.getElementById('tipo').value;
            const obs1 = document.getElementById('obs1').value;
            const anexo = document.getElementById('anexo').files[0];

            const areas = [];
            document.querySelectorAll('input[name="estampa"]:checked').forEach((checkbox) => {
                areas.push(checkbox.value);
            });

            const pedido = `
Número do Pedido: ${numeroPedido}
Nome do Cliente: ${nome}
Cor do Tecido: ${cor}
Áreas a serem estampadas: ${areas.join(', ')}
Tipo de Camiseta: ${tipo}
Observação: ${obs1}
            `.trim();

            // Enviar para o Google Drive
            const metadata = {
                name: `Pedido_${numeroPedido}_${nome}.txt`,
                mimeType: 'text/plain',
                parents: [FOLDER_ID],
            };

            const formData = new FormData();
            formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            formData.append('file', new Blob([pedido], { type: 'text/plain' }));

            try {
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        Authorization: `Bearer ${accessToken}`,
                    },
                    body: formData,
                });
                const data = await response.json();
                console.log('Arquivo enviado ao Drive:', data);
            } catch (err) {
                console.error('Erro ao enviar para o Drive:', err);
                alert('Erro ao enviar o pedido para o Drive.');
            }

            // Prepara a mensagem para WhatsApp
            let mensagem = `
*Pedido de Camiseta*\n
*Número do Pedido:* ${numeroPedido}\n
*Nome do Cliente:* ${nome}\n
*Cor do Tecido:* ${cor}\n
*Áreas a serem estampadas:* ${areas.join(', ')}\n
*Tipo de Camiseta:* ${tipo}\n
*Observação:* ${obs1}\n
            `.trim();

            if (anexo) {
                const base64Anexo = await fileToBase64(anexo);
                mensagem += `\n*Arquivo em anexo:* \n${base64Anexo}`;
            }

            const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(mensagem)}`;
            window.open(whatsappUrl, '_blank');
            numeroPedido++;
        }

        // Converte o arquivo em base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
        }
    </script>
</body>
</html>
